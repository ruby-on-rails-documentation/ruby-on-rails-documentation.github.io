(window.webpackJsonp=window.webpackJsonp||[]).push([[32],{303:function(e,t,a){"use strict";a.r(t);var n=a(13),s=Object(n.a)({},(function(){var e=this,t=e._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"asset-bundling-webpacker"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#asset-bundling-webpacker"}},[e._v("#")]),e._v(" Asset Bundling (Webpacker)")]),e._v(" "),t("ul",[t("li",[t("p",[e._v("Introduction")]),e._v(" "),t("p",[e._v("Webpacker is a Rails wrapper around the webpack build system that provides a standard webpack configuration and reasonable defaults.")]),e._v(" "),t("p",[e._v("The goal of webpack, or any front-end build system, is to allow you to write your front-end code in a way that is convenient for developers and then package that code in a way that is convenient for browsers. With webpack, you can manage JavaScript, CSS, and static assets like images or fonts. Webpack will allow you to write your code, reference other code in your application, transform your code, and combine your code into easily downloadable packs.")])]),e._v(" "),t("li",[t("p",[e._v("Installation")]),e._v(" "),t("p",[e._v("Webpacker is available out-of-the-box in the newest version of Rails. Before creating a new project, ensure that the Node version is greater or equal to 10.17.0 as the "),t("strong",[t("code",[e._v("webpacker:install")])]),e._v(" command will be automatically invoked with rails new command.")])]),e._v(" "),t("li",[t("p",[e._v("Webpacker File Structure")]),e._v(" "),t("p",[e._v("After the install command is executed, the following files are created:")]),e._v(" "),t("ul",[t("li",[t("strong",[t("code",[e._v("config/webpacker.yml")])]),e._v(" — the main configuration file that contains the default configuration and configs for specific environments")]),e._v(" "),t("li",[t("strong",[t("code",[e._v("config/webpacker/")])]),e._v(" — the directory where the JavaScript configuration files for particular environments are created")]),e._v(" "),t("li",[t("strong",[t("code",[e._v("bin/webpack")])]),e._v(" — an executable file that invokes webpack to create bundles")]),e._v(" "),t("li",[t("strong",[t("code",[e._v("bin/webpack-dev-server")])]),e._v(" — an executable file that starts the development server, which reloads webpack every time you make a change inside the JavaScript files included in the bundle")])])]),e._v(" "),t("li",[t("p",[e._v("The Anatomy of the Configuration File")]),e._v(" "),t("p",[e._v("The main configuration file for Webpacker is located under the config directory, and it’s named "),t("strong",[t("code",[e._v("webpacker.yml")])]),e._v(". Unlike Webpacker, configuration for Webpack is stored separately for each environment under the **"),t("code",[e._v("config/webpack")]),e._v("**directory.")]),e._v(" "),t("p",[t("strong",[t("strong",[e._v("Webpacker")])])]),e._v(" "),t("p",[e._v("By default, the configuration file contains many entries — default ones, and sections for each environment where you can overwrite specific settings. Let’s take a look at the most important settings:")]),e._v(" "),t("ul",[t("li",[t("strong",[t("code",[e._v("source_path")])]),e._v(" — the primary source of javascript files in your application. It’s set to "),t("strong",[t("code",[e._v("app/javascript")])]),e._v(" by default, and usually, there's no need to change this value.")]),e._v(" "),t("li",[t("strong",[t("code",[e._v("source_entry_path")])]),e._v(" — the name of the directory under the source_path where you keep the pack files, aka entry points. By default, this setting is set to the packs’ directory.")]),e._v(" "),t("li",[t("strong",[t("code",[e._v("public_root_path")])]),e._v(" — path to the directory in your application that is accessible from a browser. In a typical Rails application, it’s a public directory")]),e._v(" "),t("li",[t("strong",[t("code",[e._v("public_output_path")])]),e._v(" — when Webpacker compiles your files, it will put all compiled files in this directory under the "),t("strong",[t("code",[e._v("public_root_path")])]),e._v(". By default, the directory is named packs, but you can call it whatever you want.")]),e._v(" "),t("li",[t("strong",[t("code",[e._v("webpack_compile_output")])]),e._v(" — if the flag is set to true, then output messages are displayed when files are compiled. It’s useful when compilation fails, as you'll be aware of that and can take action.")])]),e._v(" "),t("p",[e._v("It is worth mentioning that the development section also contains configuration for the dev server that is used to compile files in the development environment without the need for restarting the server.")]),e._v(" "),t("p",[e._v("If you would like to access the configuration from the rails console or code level, you can call "),t("strong",[t("code",[e._v("Webpacker.manifest.config")])]),e._v(", which will return the configuration class instance.")]),e._v(" "),t("p",[t("strong",[t("strong",[e._v("Webpack")])])]),e._v(" "),t("p",[e._v("Each environment has its configuration file, but in every file, the main environment file is imported: "),t("strong",[t("code",[e._v("config/webpack/environment.js")])]),e._v(". In the environment configuration file, there is a place for loading custom plugins that will modify the default behavior of Webpack. We can also add custom rules for compiling our files.")]),e._v(" "),t("ul",[t("li",[t("p",[e._v("The Anatomy of the Pack File")]),e._v(" "),t("p",[e._v("Packs are located under the **"),t("code",[e._v("app/javascript/packs")]),e._v("**directory. Each pack file is treated by Webpacker as an entry point when the compilation process starts.")]),e._v(" "),t("p",[t("strong",[t("strong",[e._v("The Default Pack File")])])]),e._v(" "),t("p",[e._v("When you generate a new Rails project, a default pack file named application.js is created with the following content:")]),e._v(" "),t("div",{staticClass:"language-ruby line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ruby"}},[t("code",[e._v("import Rails from "),t("span",{pre:!0,attrs:{class:"token string-literal"}},[t("span",{pre:!0,attrs:{class:"token string"}},[e._v('"@rails/ujs"')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\nimport Turbolinks from "),t("span",{pre:!0,attrs:{class:"token string-literal"}},[t("span",{pre:!0,attrs:{class:"token string"}},[e._v('"turbolinks"')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\nimport "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v(" as ActiveStorage from "),t("span",{pre:!0,attrs:{class:"token string-literal"}},[t("span",{pre:!0,attrs:{class:"token string"}},[e._v('"@rails/activestorage"')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\nimport "),t("span",{pre:!0,attrs:{class:"token string-literal"}},[t("span",{pre:!0,attrs:{class:"token string"}},[e._v('"channels"')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n \nRails"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("start"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\nTurbolinks"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("start"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\nActiveStorage"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("start"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br"),t("span",{staticClass:"line-number"},[e._v("6")]),t("br"),t("span",{staticClass:"line-number"},[e._v("7")]),t("br"),t("span",{staticClass:"line-number"},[e._v("8")]),t("br")])]),t("p",[e._v("As you can see, the first step is to import the given library and then call its initialization method when it’s needed. When you call import, the system searches for a given node module or a local library. With the standard approach, you don’t have to explicitly initialize the library as it’s initialized when you include it in the page source with the script tag.")])]),e._v(" "),t("li",[t("p",[e._v("Including Pack Files in the Application")]),e._v(" "),t("p",[e._v("Pack files are not automatically included in the website’s source. Just like in the asset pipeline case, we have to use a special tag inside our views:")]),e._v(" "),t("div",{staticClass:"language-ruby line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ruby"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("%=")]),e._v(" javascript_packs_with_chunks_tag "),t("span",{pre:!0,attrs:{class:"token string-literal"}},[t("span",{pre:!0,attrs:{class:"token string"}},[e._v("'application'")])]),e._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("%")]),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("How does this method work? Under the hood, it calls the Webpacker configuration that holds the data you put in the **"),t("code",[e._v("config/webpacker.yml")]),e._v("**file. It looks for an application.js file inside the entry points directory, which, in our case, is "),t("strong",[t("code",[e._v("app/javascript/packs")])]),e._v("\n. You can verify it by calling the following code:")]),e._v(" "),t("div",{staticClass:"language-ruby line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ruby"}},[t("code",[e._v("Webpacker"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("manifest"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("config"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("source_entry_path\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("When entries are found, Webpacker calls **"),t("code",[e._v("javascript_include_tag")]),e._v("**method, a helper from the "),t("strong",[t("code",[e._v("ActionView")])]),e._v(" library available by default in Rails. The method accepts one or more sources and returns script tags that you can apply straight to your view.")])]),e._v(" "),t("li",[t("p",[e._v("The Development Server")]),e._v(" "),t("p",[e._v("Webpacker development server’s entry point is the executable file placed inside the "),t("strong",[t("code",[e._v("bin")])]),e._v(" folder and named "),t("strong",[t("code",[e._v("webpack-dev-server")])]),e._v(". The process of running the server consists of five steps:")]),e._v(" "),t("ul",[t("li",[t("strong",[e._v("Setting environment")]),e._v(" — the environment name for Node and Rails is set. When the environment is not specified, the program assumes that the server will be executed in the development environment.")]),e._v(" "),t("li",[t("strong",[e._v("Loading configuration")]),e._v(" — the file "),t("strong",[t("code",[e._v("config/webpacker.yml")])]),e._v(" is loaded with settings for the environment set in the previous step.")]),e._v(" "),t("li",[t("strong",[e._v("Validating command options")]),e._v(" — the program checks if we passed appropriate options to the server command. For example, it will throw an error when the "),t("strong",[t("code",[e._v("-https")])]),e._v(" option is given, but we didn’t specify it in the "),t("strong",[t("code",[e._v("config/webpacker.yml")])]),e._v(" file.")]),e._v(" "),t("li",[t("strong",[e._v("Verifying port’s availability")]),e._v(" — the program checks if the given port is available to use. If another program is already using it, it will throw an error letting you know that you have to update the webpack server configuration inside the "),t("strong",[t("code",[e._v("config/webpacker.yml")])]),e._v(" file.")]),e._v(" "),t("li",[t("strong",[e._v("Executing webpack serve command")]),e._v(" — when the node modules directory exists, the program executes the command within the directory, otherwise, it executes it with yarn. The program passes the configuration option to the command that points to one of the files placed inside the "),t("strong",[t("code",[e._v("config/webpack/")])]),e._v(" directory.")])]),e._v(" "),t("p",[e._v("The server is now running, and it compiles your code on the fly, so you don’t have to restart the server to see the changes and check if webpack was able to create the bundle with the new code.")]),e._v(" "),t("p",[e._v("The development server’s code is quite simple. It only loads the config from the configuration file in YAML format and passes the proper config in JavaScript format directly to the "),t("strong",[t("code",[e._v("webpack serve")])]),e._v(" command. You can also run it by hand, but you don’t have to take care of proper command arguments with the built-in command.")])]),e._v(" "),t("li",[t("p",[e._v("Compiling Files for the Production Environment")]),e._v(" "),t("p",[e._v("Suppose you want to deploy the application that's using webpacker. In that case, you can simply invoke the "),t("strong",[t("code",[e._v("assets:precompile")])]),e._v(" task as Webpacker automatically hooks up the task "),t("strong",[t("code",[e._v("webpacker:compile")])]),e._v(" to it.")]),e._v(" "),t("p",[e._v("How does the "),t("strong",[t("code",[e._v("webpacker:compile")])]),e._v(" task work under the hood? Let’s dig into it and see. It does the following things:")]),e._v(" "),t("ul",[t("li",[e._v("It wraps the main call into two blocks ensuring that the **"),t("code",[e._v("NODE")]),e._v("**environment is set and Webpacker logs are output to the standard out.")]),e._v(" "),t("li",[e._v("It calls Webpack and then parses its logs to determine if the action was successful or not.")])]),e._v(" "),t("p",[e._v("You can now visit the "),t("strong",[t("code",[e._v("public/packs/js")])]),e._v(" directory to see the compiled files. They should be deployed to the server.")])])])])])])}),[],!1,null,null,null);t.default=s.exports}}]);